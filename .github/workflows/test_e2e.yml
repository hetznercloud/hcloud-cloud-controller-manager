name: e2e tests
on:
  pull_request: {}
  push:
    branches: [main]
jobs:
  cloud:
    name: Cloud ${{ matrix.k3s }}
    runs-on: ubuntu-latest

    # Required for TPS
    permissions:
      id-token: write

    strategy:
      matrix:
        k3s: [ v1.25, v1.26, v1.27, v1.28 ]
      fail-fast: false

    steps:
      - uses: actions/checkout@master
      - uses: ./.github/actions/e2e
        with:
          k3s-channel: ${{ matrix.k3s }}
          scope: gha-${{ github.run_id }}-${{ github.run_attempt }}-${{ matrix.k3s }}
          # This domain is available in the account running the public integration tests.
          cert-domain: hc-integrations-test.de


  robot:
    name: Robot
    runs-on: ubuntu-latest

    # Required for TPS
    permissions:
      id-token: write

    # Make sure that only one Job is using the server at a time
    concurrency: robot-test-server
    environment: e2e-robot

    steps:
      - uses: actions/checkout@master
      - uses: ./.github/actions/e2e
        with:
          k3s-channel: v1.28
          scope: gha-${{ github.run_id }}-${{ github.run_attempt }}-robot

          routes-enabled: "false"
          robot-enabled: "true"
          robot-server-number: ${{ vars.SERVER_NUMBER }}
