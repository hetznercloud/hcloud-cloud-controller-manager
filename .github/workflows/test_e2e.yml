name: Run e2e tests
on:
  pull_request: {}
  push:
    branches: [main]
jobs:
  k3s:
    name: k3s ${{ matrix.k3s }}
    permissions:
      id-token: write
    runs-on: ubuntu-latest
    strategy:
      matrix:
        k3s: [ v1.24, v1.25, v1.26, v1.27]
      fail-fast: false
    steps:
      - uses: actions/setup-go@v4
        with:
          go-version: '1.20'
      - uses: actions/checkout@master
      - name: HCLOUD_TOKEN
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
          TTS_TOKEN: ${{ secrets.TTS_TOKEN }}
        run: |
          set -ueo pipefail
          if [[ "${HCLOUD_TOKEN:-}" != "" ]]; then
            echo "HCLOUD_TOKEN=$HCLOUD_TOKEN" >> "$GITHUB_ENV"
          elif [[ "${{vars.USE_TPS}}" != "" ]]; then
                    ci_token=$(curl --fail --retry 2 -s \
                        -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
                        "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=tps" \
                        | jq -r .value)
                    token="$(curl --fail --retry 2 -s -X POST -H "Authorization: Bearer $ci_token" https://tps.hc-integrations.de/)"
                    echo "::add-mask::$token"
                    echo "HCLOUD_TOKEN=$token" >> "$GITHUB_ENV"
          elif [[ "${TTS_TOKEN:-}" != "" ]]; then
                    token="$(./scripts/get-token.sh)"
                    echo "::add-mask::$token"
                    echo "HCLOUD_TOKEN=$token" >> "$GITHUB_ENV"
          else
            echo "::error ::Couldn't determine HCLOUD_TOKEN. Check that repository secrets are setup correctly."
            exit 1
          fi

      - uses: 3bit/setup-hcloud@v2
      - uses: yokawasa/action-setup-kube-tools@v0.9.3
        with:
          setup-tools: |
            helm
            kubectl
            skaffold
          helm: v3.11.2
          kubectl: v1.26.3
          skaffold: v2.3.0

      - name: Run tests
        env:
          K3S_CHANNEL: ${{ matrix.k3s }}
          SCOPE: gha-${{ github.run_id }}-${{ github.run_attempt }}-${{ matrix.k3s }}
        run: |
          curl -sLS https://get.k3sup.dev | sh

          trap "hack/dev-down.sh; ./scripts/delete-token.sh $HCLOUD_TOKEN" EXIT
          source <(hack/dev-up.sh)

          skaffold build --tag="e2e-${GITHUB_RUN_ID}-${GITHUB_RUN_NUMBER}"
          tag=$(skaffold build --tag="e2e-${GITHUB_RUN_ID}-${GITHUB_RUN_NUMBER}" --quiet --output="{{ (index .Builds 0).Tag }}")
          skaffold deploy --images=hetznercloud/hcloud-cloud-controller-manager=$tag
          go test ./tests/e2e -v -timeout 60m
